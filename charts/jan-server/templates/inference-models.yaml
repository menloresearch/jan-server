{{- if .Values.inference.enabled }}
{{- range .Values.inference.models }}
{{- if .enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .name }}
  labels:
    {{- include "jan-server.labels" $ | nindent 4 }}
    model.aibrix.ai/name: {{ .name }}
    model.aibrix.ai/port: {{ .port | quote }}
  {{- with .labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if not .autoscaler.enabled }}
  replicas: {{ .replicaCount | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      model.aibrix.ai/name: {{ .name }}
  strategy:
    {{- toYaml .strategy | nindent 4 }}
  template:
    metadata:
      annotations:
        {{- with .podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        model.aibrix.ai/name: {{ .name }}
        {{- with .podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      containers:
        - name: vllm-openai
          image: {{ .image }}
          imagePullPolicy: {{ .imagePullPolicy }}
          {{- if .command }}
          command:
            {{- toYaml .command | nindent 12 }}
          {{- end }}
          {{- if .args }}
          args:
            {{- range .args }}
            - {{ . | quote }}
            {{- end }}
          {{- end }}
          ports:
            - containerPort: {{ .port | default 8000 }}
              protocol: TCP
          env:
            {{- with .extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with .livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if or (and $.Values.inference.storage.enabled .useSharedStorage) .storage.enabled }}
          volumeMounts:
            {{- if and $.Values.inference.storage.enabled .useSharedStorage }}
            - name: shared-hf-cache
              mountPath: {{ $.Values.inference.storage.hfCachePath }}
              subPath: {{ $.Values.inference.storage.hfCacheSubPath }}
            - name: shared-hf-cache
              mountPath: {{ $.Values.inference.storage.vllmCompilePath }}
              subPath: {{ $.Values.inference.storage.vllmCompileSubPath }}
            {{- else if .storage.enabled }}
            - name: hf-cache
              mountPath: {{ .storage.hfCachePath }}
              subPath: {{ .storage.hfCacheSubPath }}
            - name: hf-cache
              mountPath: {{ .storage.vllmCompilePath }}
              subPath: {{ .storage.vllmCompileSubPath }}
            {{- end }}
          {{- end }}
      {{- if or (and $.Values.inference.storage.enabled .useSharedStorage) .storage.enabled }}
      volumes:
        {{- if and $.Values.inference.storage.enabled .useSharedStorage }}
        - name: shared-hf-cache
          persistentVolumeClaim:
            claimName: {{ $.Values.inference.storage.pvcName }}
        {{- else if .storage.enabled }}
        - name: hf-cache
          persistentVolumeClaim:
            claimName: {{ .storage.pvcName }}
        {{- end }}
      {{- end }}
      {{- with .nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .name }}
  labels:
    {{- include "jan-server.labels" $ | nindent 4 }}
    model.aibrix.ai/name: {{ .name }}
    prometheus-discovery: "true"
  annotations:
    {{- with .service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: {{ .service.type }}
  ports:
    - name: serve
      port: {{ .service.port }}
      protocol: TCP
      targetPort: {{ .service.targetPort }}
  selector:
    model.aibrix.ai/name: {{ .name }}

{{- if .serviceMonitor.enabled }}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ .name }}
  labels:
    {{- include "jan-server.labels" $ | nindent 4 }}
    model.aibrix.ai/name: {{ .name }}
spec:
  endpoints:
    - port: serve
      path: {{ .serviceMonitor.path }}
      interval: {{ .serviceMonitor.interval }}
  selector:
    matchLabels:
      model.aibrix.ai/name: {{ .name }}
{{- end }}

{{- if and .autoscaler.enabled (ne .autoscaler.type "HPA") }}
---
apiVersion: autoscaling.aibrix.ai/v1alpha1
kind: PodAutoscaler
metadata:
  name: {{ .name }}-autoscaler
  labels:
    {{- include "jan-server.labels" $ | nindent 4 }}
    app.kubernetes.io/name: aibrix
    app.kubernetes.io/managed-by: kustomize
  annotations:
    {{- with .autoscaler.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  scalingStrategy: {{ .autoscaler.type }}
  minReplicas: {{ .autoscaler.minReplicas }}
  maxReplicas: {{ .autoscaler.maxReplicas }}
  metricsSources:
    {{- if eq .autoscaler.metricsSource.metricSourceType "pod" }}
    - metricSourceType: {{ .autoscaler.metricsSource.metricSourceType }}
      protocolType: {{ .autoscaler.metricsSource.protocolType }}
      port: {{ .autoscaler.metricsSource.port | quote }}
      path: {{ .autoscaler.metricsSource.path }}
      targetMetric: {{ .autoscaler.metricsSource.targetMetric }}
      targetValue: {{ .autoscaler.metricsSource.targetValue | quote }}
    {{- else if eq .autoscaler.metricsSource.metricSourceType "domain" }}
    - endpoint: {{ .autoscaler.metricsSource.endpoint }}
      metricSourceType: {{ .autoscaler.metricsSource.metricSourceType }}
      path: {{ .autoscaler.metricsSource.path }}
      protocolType: {{ .autoscaler.metricsSource.protocolType }}
      targetMetric: {{ .autoscaler.metricsSource.targetMetric }}
      targetValue: {{ .autoscaler.metricsSource.targetValue | quote }}
    {{- end }}
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .name }}
{{- end }}

{{- if and .autoscaler.enabled (eq .autoscaler.type "HPA") }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .name }}-hpa
  labels:
    {{- include "jan-server.labels" $ | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .name }}
  minReplicas: {{ .autoscaler.minReplicas }}
  maxReplicas: {{ .autoscaler.maxReplicas }}
  metrics:
    {{- if .autoscaler.hpa.targetCPUUtilizationPercentage }}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .autoscaler.hpa.targetCPUUtilizationPercentage }}
    {{- end }}
    {{- if .autoscaler.hpa.targetMemoryUtilizationPercentage }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .autoscaler.hpa.targetMemoryUtilizationPercentage }}
    {{- end }}
{{- end }}

{{- end }}
{{- end }}
{{- end }}