graph TB
    subgraph "Client Layer"
        WEB[Web Client]
        API_CLIENT[API Client]
        MOBILE[Mobile App]
        PROFILER[Profiling Tools<br/>pprof/Pyroscope]
    end
    
    subgraph "Jan API Gateway"
        subgraph "HTTP Layer"
            GIN[Gin Router<br/>Port 8080]
            MIDDLEWARE[Middleware<br/>- CORS<br/>- JWT Auth<br/>- Logging<br/>- Transaction<br/>- Request ID]
        end
        
        subgraph "Route Handlers"
            AUTH_ROUTE[Authentication API<br/>- Google OAuth2<br/>- JWT Management<br/>- Guest Login]
            CHAT_ROUTE[Chat Completions API<br/>- OpenAI Compatible<br/>- Streaming Support<br/>- Models & MCP]
            CONV_ROUTE[Conversation-aware Chat API<br/>- Context-aware Completions<br/>- MCP Integration]
            CONV_MGMT_ROUTE[Conversations API<br/>- CRUD Operations<br/>- Item Management]
            ADMIN_ROUTE[Administration API<br/>- Organization Management<br/>- Project Management<br/>- API Key Management]
            RESPONSE_ROUTE[Responses API<br/>- Response Tracking<br/>- Status Management]
            SERVER_ROUTE[Server API<br/>- Version Info<br/>- Health Checks]
        end
        
        subgraph "Business Logic Layer"
            USER_SVC[User Service<br/>- Authentication<br/>- Profile Management<br/>- Guest Users]
            CONV_SVC[Conversation Service<br/>- Message Storage<br/>- Thread Management<br/>- Context Handling]
            ORG_SVC[Organization Service<br/>- Multi-tenancy<br/>- Access Control<br/>- Project Management]
            API_KEY_SVC[API Key Service<br/>- Key Generation<br/>- Validation<br/>- Scoped Access]
            MCP_SVC[MCP Service<br/>- Tool Integration<br/>- External APIs<br/>- JSON-RPC 2.0]
            RESPONSE_SVC[Response Service<br/>- Status Tracking<br/>- Usage Statistics<br/>- Error Handling]
            HEALTH_SVC[Health Service<br/>- Model Monitoring<br/>- Cron Jobs<br/>- Registry Management]
        end
        
        subgraph "Data Layer"
            USER_REPO[User Repository<br/>- Guest Users<br/>- Profile Data]
            CONV_REPO[Conversation Repository<br/>- Thread Storage<br/>- Metadata]
            ITEM_REPO[Item Repository<br/>- Messages<br/>- Content Types]
            ORG_REPO[Organization Repository<br/>- Multi-tenant Data<br/>- Access Control]
            PROJECT_REPO[Project Repository<br/>- Resource Isolation<br/>- Member Management]
            API_KEY_REPO[API Key Repository<br/>- Scoped Keys<br/>- Usage Tracking]
            RESPONSE_REPO[Response Repository<br/>- Status Tracking<br/>- Usage Data]
            TX_MGR[Transaction Manager<br/>- Auto Rollback<br/>- Context Handling<br/>- Read/Write Split]
        end
        
        subgraph "Infrastructure"
            DB_WRITE[(PostgreSQL<br/>Write Replica)]
            DB_READ[(PostgreSQL<br/>Read Replicas)]
            PPROF[pprof Server<br/>Port 6060]
            CRON[Cron Scheduler<br/>Health Checks]
        end
        
        subgraph "External Services"
            JAN_INFERENCE[Jan Inference<br/>Service]
            SERPER_API[Serper API<br/>Web Search]
            GOOGLE_OAUTH[Google OAuth2<br/>Authentication]
            PYROSCOPE[Grafana Pyroscope<br/>Continuous Profiling]
        end
    end
    
    %% Client connections
    WEB --> GIN
    API_CLIENT --> GIN
    MOBILE --> GIN
    PROFILER --> PPROF
    
    %% HTTP layer connections
    GIN --> MIDDLEWARE
    MIDDLEWARE --> AUTH_ROUTE
    MIDDLEWARE --> CHAT_ROUTE
    MIDDLEWARE --> CONV_ROUTE
    MIDDLEWARE --> CONV_MGMT_ROUTE
    MIDDLEWARE --> ADMIN_ROUTE
    MIDDLEWARE --> RESPONSE_ROUTE
    MIDDLEWARE --> SERVER_ROUTE
    
    %% Route to service connections
    AUTH_ROUTE --> USER_SVC
    CHAT_ROUTE --> CONV_SVC
    CHAT_ROUTE --> MCP_SVC
    CHAT_ROUTE --> HEALTH_SVC
    CONV_ROUTE --> CONV_SVC
    CONV_ROUTE --> MCP_SVC
    CONV_MGMT_ROUTE --> CONV_SVC
    ADMIN_ROUTE --> ORG_SVC
    ADMIN_ROUTE --> API_KEY_SVC
    RESPONSE_ROUTE --> RESPONSE_SVC
    SERVER_ROUTE --> HEALTH_SVC
    
    %% Service to repository connections
    USER_SVC --> USER_REPO
    CONV_SVC --> CONV_REPO
    CONV_SVC --> ITEM_REPO
    ORG_SVC --> ORG_REPO
    ORG_SVC --> PROJECT_REPO
    API_KEY_SVC --> API_KEY_REPO
    RESPONSE_SVC --> RESPONSE_REPO
    
    %% Repository to database connections
    USER_REPO --> TX_MGR
    CONV_REPO --> TX_MGR
    ITEM_REPO --> TX_MGR
    ORG_REPO --> TX_MGR
    PROJECT_REPO --> TX_MGR
    API_KEY_REPO --> TX_MGR
    RESPONSE_REPO --> TX_MGR
    TX_MGR --> DB_WRITE
    TX_MGR --> DB_READ
    
    %% Infrastructure connections
    HEALTH_SVC --> CRON
    HEALTH_SVC --> JAN_INFERENCE
    
    %% External service connections
    CHAT_ROUTE --> JAN_INFERENCE
    CONV_ROUTE --> JAN_INFERENCE
    MCP_SVC --> SERPER_API
    AUTH_ROUTE --> GOOGLE_OAUTH
    PPROF --> PYROSCOPE
    
    %% Styling
    classDef clientClass fill:#e1f5fe
    classDef gatewayClass fill:#f3e5f5
    classDef serviceClass fill:#e8f5e8
    classDef dataClass fill:#fff3e0
    classDef externalClass fill:#fce4ec
    classDef infraClass fill:#f1f8e9
    
    class WEB,API_CLIENT,MOBILE,PROFILER clientClass
    class GIN,MIDDLEWARE,AUTH_ROUTE,CHAT_ROUTE,CONV_ROUTE,CONV_MGMT_ROUTE,ADMIN_ROUTE,RESPONSE_ROUTE,SERVER_ROUTE gatewayClass
    class USER_SVC,CONV_SVC,ORG_SVC,API_KEY_SVC,MCP_SVC,RESPONSE_SVC,HEALTH_SVC serviceClass
    class USER_REPO,CONV_REPO,ITEM_REPO,ORG_REPO,PROJECT_REPO,API_KEY_REPO,RESPONSE_REPO,TX_MGR,DB_WRITE,DB_READ dataClass
    class JAN_INFERENCE,SERPER_API,GOOGLE_OAUTH,PYROSCOPE externalClass
    class PPROF,CRON infraClass